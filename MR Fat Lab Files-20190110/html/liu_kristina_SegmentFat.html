
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>liu_kristina_SegmentFat</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-01-18"><meta name="DC.source" content="liu_kristina_SegmentFat.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Load images</a></li><li><a href="#4">Calculate Fat Fraction Map in [%]</a></li><li><a href="#5">Create Body/Good SNR Mask</a></li><li><a href="#6">Apply a 2D filter to the mask (see help medfilt2)</a></li><li><a href="#7">Apply this Body/SNR Mask to the FF map</a></li><li><a href="#9">Manually Draw Visceral Fat ROI</a></li><li><a href="#10">Characterize VAT ROI - histogram, size in pixels, mean, median, std</a></li><li><a href="#11">Part III  - Semiautomatically Generate VAT ROI -</a></li><li><a href="#12">--Repeat for the masked Fat Fraction Map</a></li><li><a href="#14">Part IV - Determine Accuracy, Differences</a></li><li><a href="#17">Part V - Compare Post VAT vs. Pre VAT</a></li><li><a href="#19">Part  VI SAT Measurement</a></li></ul></div><pre class="codeinput"><span class="comment">% Kristina Liu</span>
<span class="comment">% BI 265</span>
<span class="comment">% Measurement of Fat Lab</span>
</pre><h2 id="2">Load images</h2><pre class="codeinput">clear <span class="string">all</span>; close <span class="string">all</span>; clc

current_dir = pwd;

<span class="comment">%input = readidf_file_pc(current_file, current_dir);</span>
<span class="comment">%See help for options, esp for different operating systems</span>
<span class="comment">%image data will be stored in &lt;input&gt;.img</span>

<span class="comment">%Pre Diet</span>
current_file = <span class="string">'data/suc047_4_S10'</span>;
VATslicePre = 30;  <span class="comment">%15 if counting from first slice, 30 if counting from superior end</span>

InPrer = read_idf_image_pc(strcat(current_file, <span class="string">'_In'</span>), current_dir, 0);
OutPrer = read_idf_image_pc(strcat(current_file, <span class="string">'_Out'</span>), current_dir, 0);
FPrer = read_idf_image_pc(strcat(current_file, <span class="string">'_F'</span>), current_dir, 0);
WPrer = read_idf_image_pc(strcat(current_file, <span class="string">'_W'</span>), current_dir, 0);
<span class="comment">%record image size parameters</span>
img_size = size(InPrer.img(:,:,:));
<span class="comment">%FYI</span>
<span class="comment">%img_rl = img_size(1);</span>
<span class="comment">%img_ap = img_size(2);</span>
num_slices = img_size(3);
<span class="comment">%other methods of collecting information: im.data, im.img</span>

<span class="comment">%Rotate and Flip the images to be in matlab-style format</span>
<span class="keyword">for</span> j=1:num_slices
    FPre(:,:,j) = flipud(imrotate(FPrer.img(:,:,j),90));
    WPre(:,:,j) = flipud(imrotate(WPrer.img(:,:,j),90));
    InPre(:,:,j) = flipud(imrotate(InPrer.img(:,:,j),90));
    OutPre(:,:,j) = flipud(imrotate(OutPrer.img(:,:,j),90));
<span class="keyword">end</span>


<span class="comment">%Display the image by slice - check read correctly</span>
figure(<span class="string">'Name'</span>, strcat(<span class="string">'Original Image: '</span>, current_file))
<span class="keyword">for</span> j=1:img_size(3)
    imagesc(FPre(:,:,j))
    axis <span class="string">image</span>
    title({<span class="string">'Fat: Slice'</span>,j});
    colormap <span class="string">gray</span>
    pause(0.1)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_01.png" alt=""> <pre class="codeinput"><span class="comment">%Post Diet</span>
current_dir = pwd;
current_file = <span class="string">'data/suc047_2_S21'</span>;
VATslicePost = 27;   <span class="comment">%18 if counting from first slice (inferior), 27 if counting</span>
<span class="comment">%from superior end</span>

InPostr = read_idf_image_pc(strcat(current_file, <span class="string">'_In'</span>), current_dir, 0);
OutPostr = read_idf_image_pc(strcat(current_file, <span class="string">'_Out'</span>), current_dir, 0);
FPostr = read_idf_image_pc(strcat(current_file, <span class="string">'_F'</span>), current_dir, 0);
WPostr = read_idf_image_pc(strcat(current_file, <span class="string">'_W'</span>), current_dir, 0);

<span class="comment">%record image size parameters</span>
img_size = size(InPostr.img(:,:,:));
<span class="comment">%FYI</span>
<span class="comment">%img_rl = img_size(1);</span>
<span class="comment">%img_ap = img_size(2);</span>
num_slices = img_size(3);
<span class="comment">%other methods of collecting information: im.data, im.img</span>

<span class="comment">%Rotate and Flip the images to be in matlab-style format</span>
<span class="keyword">for</span> j=1:num_slices
    FPost(:,:,j) = flipud(imrotate(FPostr.img(:,:,j),90));
    WPost(:,:,j) = flipud(imrotate(WPostr.img(:,:,j),90));
    InPost(:,:,j) = flipud(imrotate(InPostr.img(:,:,j),90));
    OutPost(:,:,j) = flipud(imrotate(OutPostr.img(:,:,j),90));
<span class="keyword">end</span>


<span class="comment">%Display the image by slice - check read correctly</span>
figure(<span class="string">'Name'</span>, strcat(<span class="string">'Original Image: '</span>, current_file))
<span class="keyword">for</span> j=1:img_size(3)
    imagesc(FPost(:,:,j))
    axis <span class="string">image</span>
    title({<span class="string">'Fat: Slice'</span>,j});
    colormap <span class="string">gray</span>
    pause(0.1)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_02.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_03.png" alt=""> <h2 id="4">Calculate Fat Fraction Map in [%]</h2><pre class="codeinput">close <span class="string">all</span>;
FF_Pre=FPre(:,:,VATslicePre)./(FPre(:,:,VATslicePre)+WPre(:,:,VATslicePre));
figure(<span class="string">'Name'</span>, <span class="string">'Fat Fraction Pre Diet'</span>)
imagesc(FF_Pre); colormap <span class="string">gray</span>

FF_Post=FPost(:,:,VATslicePost)./(FPost(:,:,VATslicePost)+ <span class="keyword">...</span>
    WPost(:,:,VATslicePost));
figure(<span class="string">'Name'</span>, <span class="string">'Fat Fraction Post Diet'</span>)
imagesc(FF_Post); colormap <span class="string">gray</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_04.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_05.png" alt=""> <h2 id="5">Create Body/Good SNR Mask</h2><pre class="codeinput">close <span class="string">all</span>;
MaskInPre=zeros(img_size(1));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> InPre(i,j,30)&gt;125
            MaskInPre(i,j)=1;
        <span class="keyword">else</span>
            MaskInPre(i,j)=0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
figure(<span class="string">'Name'</span>, <span class="string">'Body Mask Pre Diet'</span>)
imagesc(MaskInPre); colormap <span class="string">gray</span>

MaskInPost=zeros(img_size(1));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> InPost(i,j,30)&gt;175
            MaskInPost(i,j)=1;
        <span class="keyword">else</span>
            MaskInPost(i,j)=0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
figure(<span class="string">'Name'</span>, <span class="string">'Body Mask Post Diet'</span>)
imagesc(MaskInPre); colormap <span class="string">gray</span>

<span class="comment">%Threshold an image set</span>
<span class="comment">%example:</span>
<span class="comment">%Inmask = In&gt;100;</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_06.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_07.png" alt=""> <h2 id="6">Apply a 2D filter to the mask (see help medfilt2)</h2><pre class="codeinput">close <span class="string">all</span>;
MaskIn_Pre=medfilt2(MaskInPre);
<span class="comment">%Evaluate filter -&gt; Display, confirm threshold and filter choice</span>
figure(<span class="string">'Name'</span>, <span class="string">'2D Mask for Pre Diet'</span>)
imagesc(MaskIn_Pre); colormap <span class="string">gray</span>
MaskIn_Post=medfilt2(MaskInPost);
<span class="comment">%Evaluate filter -&gt; Display, confirm threshold and filter choice</span>
figure(<span class="string">'Name'</span>, <span class="string">'2D Mask for Post Diet'</span>)
imagesc(MaskIn_Post); colormap <span class="string">gray</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_08.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_09.png" alt=""> <h2 id="7">Apply this Body/SNR Mask to the FF map</h2><pre class="codeinput">close <span class="string">all</span>;
FF_Pre_masked = MaskIn_Pre.*FF_Pre;
figure(<span class="string">'Name'</span>, <span class="string">'Pre Diet Masked FF'</span>)
imagesc(FF_Pre_masked); colormap <span class="string">gray</span>

FF_Post_masked = MaskIn_Post.*FF_Post;
figure(<span class="string">'Name'</span>, <span class="string">'Post Diet Masked FF'</span>)
imagesc(FF_Post_masked); colormap <span class="string">gray</span>

<span class="comment">%Select Slice of Interest</span>
<span class="comment">%example:</span>
<span class="comment">%FFi=FF(:,:,VATslice);</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_10.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_11.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;
subplot(1,3,1)
imagesc(FF_Pre); colormap <span class="string">gray</span>
title(<span class="string">'Pre Diet FF map'</span>)
subplot(1,3,2)
imagesc(MaskIn_Pre); colormap <span class="string">gray</span>
title(<span class="string">'Pre Diet Body Mask'</span>)
subplot(1,3,3)
imagesc(FF_Post_masked); colormap <span class="string">gray</span>
title(<span class="string">'Pre Diet Masked FF'</span>)

<span class="comment">% The FF mask has the noise outside the body which the body mask removed in</span>
<span class="comment">% the masked FF. Step 3 and 4 created a median smoothed mask that allowed</span>
<span class="comment">% values for values within the body and made everything outside 0.</span>
<span class="comment">% Changing the threshold will change the size and shape of the body mask.</span>
<span class="comment">% You will not want to do these steps when thresholding does not</span>
<span class="comment">% differetiate noise from stucture well.</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_12.png" alt=""> <h2 id="9">Manually Draw Visceral Fat ROI</h2><pre class="codeinput">close <span class="string">all</span>;
<span class="comment">%Display image</span>
figure(<span class="string">'name'</span>,<span class="string">'FF Pre Diet'</span>)
imagesc(FF_Pre_masked);
title(<span class="string">'Manually Draw ROI of VAT'</span>);
colormap <span class="string">gray</span>
<span class="comment">%start timing</span>
tic
<span class="comment">%Code to draw an ROI</span>
freehandroi_man=imfreehand(gca);
manVATmask_Pre=createMask(freehandroi_man);
<span class="comment">%end timing</span>
manualVATtime_Pre = toc
manVATmask_Pre_num = double(manVATmask_Pre);
manVATFF_Pre=manVATmask_Pre_num.*FF_Pre_masked;
</pre><pre class="codeoutput">
manualVATtime_Pre =

   35.4512

</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_13.png" alt=""> <h2 id="10">Characterize VAT ROI - histogram, size in pixels, mean, median, std</h2><pre class="codeinput">figure(<span class="string">'Name'</span>, <span class="string">'ROI FF Pre Diet'</span>)
imagesc(manVATFF_Pre); colormap <span class="string">gray</span>

manVATFF_Pre(isnan(manVATFF_Pre))=0;
manVATFF_Pre_mean = mean(mean(manVATFF_Pre));
manVATFF_Pre_median = median(median(manVATFF_Pre));
manVATFF_Pre_std = std(std(manVATFF_Pre));
figure()
manVAT_Pre_histogram = histogram(manVATFF_Pre);
manVATFF_Pre_size = 0;
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> manVATFF_Pre(i,j)&gt;0
            manVATFF_Pre_size = manVATFF_Pre_size+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%eg:</span>
<span class="comment">%manVATmean = mean(FFi(manVATmask)),</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_14.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_15.png" alt=""> <h2 id="11">Part III  - Semiautomatically Generate VAT ROI -</h2><p>2-Automatically generate VAT mask and VAT-FF for:   1-Use Fat Fraction Map, 2 - Use masked Fat Fraction Map</p><pre class="codeinput">close <span class="string">all</span>;
<span class="comment">%1-Manually Draw Visceral ROI</span>
<span class="comment">%Display image</span>
figure(<span class="string">'name'</span>,<span class="string">'FF Pre Diet'</span>)
imagesc(FF_Pre);
title(<span class="string">'Manually Draw ROI of VAT'</span>);
colormap <span class="string">gray</span>
<span class="comment">%start timing</span>
tic
<span class="comment">%Code to draw an ROI</span>
freehandroi_aut=imfreehand(gca);
autVATmask_Pre=createMask(freehandroi_aut);
<span class="comment">%end timing</span>
autVATmask_Pre_num = double(autVATmask_Pre);
autVATroi_Pre=autVATmask_Pre_num.*FF_Pre;
figure(<span class="string">'Name'</span>, <span class="string">'Automatic ROI FF Pre Diet'</span>)
imagesc(autVATroi_Pre); colormap <span class="string">gray</span>
<span class="comment">%Threshold the FF map to &gt; 50</span>
autVATthresh_Pre=zeros(img_size(1));
<span class="keyword">for</span> i = 1:img_size(1);
    <span class="keyword">for</span> j = 1:img_size(2);
        <span class="keyword">if</span> FF_Pre(i,j)&gt;0.5
            autVATthresh_Pre(i,j)=autVATroi_Pre(i,j);
        <span class="keyword">else</span>
           autVATthresh_Pre(i,j)=0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
figure(<span class="string">'Name'</span>, <span class="string">'Automatic FF Pre Diet'</span>)
imagesc(autVATthresh_Pre); colormap <span class="string">gray</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_16.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_17.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_18.png" alt=""> <h2 id="12">--Repeat for the masked Fat Fraction Map</h2><pre class="codeinput">close <span class="string">all</span>;
<span class="comment">%1-Manually Draw Visceral ROI</span>
<span class="comment">%Display image</span>
figure(<span class="string">'name'</span>,<span class="string">'FF Pre Diet'</span>)
imagesc(FF_Pre_masked);
title(<span class="string">'Manually Draw ROI of VAT'</span>);
colormap <span class="string">gray</span>
<span class="comment">%start timing</span>
tic
<span class="comment">%Code to draw an ROI</span>
freehandroi_aut_masked=imfreehand(gca);
autVATmask_Pre_masked=createMask(freehandroi_aut_masked);
<span class="comment">%end timing</span>
autVATmask_Pre_num_masked = double(autVATmask_Pre_masked);
autVATroi_Pre_masked=autVATmask_Pre_num_masked.*FF_Pre_masked;
figure(<span class="string">'Name'</span>, <span class="string">'Automatic ROI FF Pre Diet'</span>)
imagesc(autVATroi_Pre_masked); colormap <span class="string">gray</span>
<span class="comment">%Threshold the FF map to &gt; 50</span>
autVATthresh_Pre_masked=zeros(img_size(1));
<span class="comment">%Generate a VAT ROI Fat Fraction (masked by viscera and by FF &gt; 50)</span>
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> FF_Pre_masked(i,j)&gt;0.5
            autVATthresh_Pre_masked(i,j)=autVATroi_Pre_masked(i,j);
        <span class="keyword">else</span>
           autVATthresh_Pre_masked(i,j)=0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%Make a Figure of VAT ROI FF image</span>
figure(<span class="string">'Name'</span>, <span class="string">'Automatic masked FF Pre Diet'</span>)
imagesc(autVATthresh_Pre_masked); colormap <span class="string">gray</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_19.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_20.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_21.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;
<span class="comment">%Create a histogram of the VAT ROI Fat Fraction values</span>
figure(<span class="string">'Name'</span>, <span class="string">'Visceral FF ROI'</span>)
autVAT_Pre__mask_histogram = histogram(autVATthresh_Pre_masked,10);
figure(<span class="string">'Name'</span>, <span class="string">'VAT FF ROI'</span>)
manVAT_Pre_histogram = histogram(manVATFF_Pre,10);
<span class="comment">% Both histograms contain a majority of 0s.</span>
<span class="comment">% The visceral FF ROI has distribution from</span>
<span class="comment">% 0.1 to 1. VAT ROI has a distribution between 0.5 and 1.</span>
<span class="comment">% We have this shape for VAT because we</span>
<span class="comment">% thresholded all values below 0.5 while for the visceral ROI we manually</span>
<span class="comment">% drew it out.</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_22.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_23.png" alt=""> <h2 id="14">Part IV - Determine Accuracy, Differences</h2><pre class="codeinput">close <span class="string">all</span>;
autVATthresh_Pre(isnan(autVATthresh_Pre))=0;
autVATthresh_Pre_mean = mean(mean(autVATthresh_Pre));
autVATthresh_Pre_median = median(median(autVATthresh_Pre));
autVATthresh_Pre_std = std(std(autVATthresh_Pre));
autVATthresh_Pre_size = 0;
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre(i,j)&gt;0
            autVATthresh_Pre_size = autVATthresh_Pre_size+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
autVATthresh_Pre_masked(isnan(autVATthresh_Pre_masked))=0;
autVATthresh_Pre_masked_mean = mean(mean(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_median = median(median(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_std = std(std(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_size = 0;
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre(i,j)&gt;0
            autVATthresh_Pre_masked_size = autVATthresh_Pre_masked_size+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

overlap_masked_FF_man_ROI = zeros(size(img_size));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre_masked(i,j) &amp;&amp; manVATFF_Pre(i,j)&gt;0
            overlap_masked_FF_man_ROI(i,j) = 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

overlap_VAT_Visc = zeros(size(img_size));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre_masked(i,j) &amp;&amp; manVATFF_Pre(i,j)&gt;0
            overlap_VAT_Visc = overlap_VAT_Visc+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
overlap_both_auto = zeros(size(img_size));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre_masked(i,j) &amp;&amp; autVATthresh_Pre(i,j)&gt;0
            overlap_both_auto(i,j) = 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

overlap_mask = zeros(size(img_size));
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Pre_masked(i,j) &amp;&amp; autVATthresh_Pre(i,j)&gt;0
            overlap_mask = overlap_mask+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%Calculate Dice Coefficient &amp; the %Difference in Size</span>
<span class="comment">%A - Compare VAT ROI on masked FF vs. manual VAT ROI</span>
DC_VAT_Visc= 2.*overlap_both_auto/(manVATFF_Pre_size + <span class="keyword">...</span>
    autVATthresh_Pre_masked_size);
VAT_Visc_perc_diff = (manVATFF_Pre_size-autVATthresh_Pre_masked_size)/<span class="keyword">...</span>
    manVATFF_Pre_size;

<span class="comment">%B - Compare VAT ROI on masked FF to the VAT ROI on FF (not masked)</span>

DC_VAT_Visc= 2.*overlap_mask/(autVATthresh_Pre_size + <span class="keyword">...</span>
    autVATthresh_Pre_masked_size);
mask_perc_diff = (autVATthresh_Pre_size + autVATthresh_Pre_masked_size)/<span class="keyword">...</span>
    autVATthresh_Pre_size;
</pre><pre class="codeinput"><span class="comment">%Display FF image, 2 masks, and overlap of the 2 masks</span>
<span class="comment">% A</span>
close <span class="string">all</span>;
figure(<span class="string">'Name'</span>, <span class="string">'A'</span>)
subplot(4,1,1)
imagesc(FF_Pre_masked); colormap <span class="string">gray</span>
title(<span class="string">'Masked FF Pre Diet'</span>)
subplot(4,1,2)
imagesc(autVATthresh_Pre_masked); colormap <span class="string">gray</span>
title(<span class="string">'Automatic masked ROI Pre Diet'</span>)
subplot(4,1,3)
imagesc(manVATFF_Pre); colormap <span class="string">gray</span>
title(<span class="string">'Manual VAT Roi Pre Diet'</span>)
subplot(4,1,4)
imagesc(overlap_masked_FF_man_ROI); colormap <span class="string">gray</span>
title(<span class="string">'Overlap Manual and Automatic'</span>)
<span class="comment">% B</span>
figure(<span class="string">'Name'</span>, <span class="string">'B'</span>)
subplot(4,1,1)
imagesc(FF_Pre_masked); colormap <span class="string">gray</span>
title(<span class="string">'Masked FF Pre Diet'</span>)
subplot(4,1,2)
imagesc(autVATthresh_Pre); colormap <span class="string">gray</span>
title(<span class="string">'Automatic masked FF Pre Diet'</span>)
subplot(4,1,3)
imagesc(autVATthresh_Pre_masked); colormap <span class="string">gray</span>
title(<span class="string">'Automatic FF Pre Diet'</span>)
subplot(4,1,4)
imagesc(overlap_both_auto); colormap <span class="string">gray</span>
title(<span class="string">'Overlap Manual and Automatic'</span>)

<span class="comment">% The manual approach allows for fat fractions less than 0.5 percent</span>
<span class="comment">%which the automatic ones does not.</span>
<span class="comment">% Automatically thresholding with an without noise makes no difference</span>
<span class="comment">% because they are NaN and replaced with zeros.</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_24.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_25.png" alt=""> <pre class="codeinput"><span class="comment">%Calculate &amp; Report stats on the VAT ROIs</span>
<span class="comment">%Summary of Results</span>
disp(sprintf(<span class="string">'Parameter        Manual VAT        Semiauto VAT'</span>))
disp(sprintf(<span class="string">'volume             2973               1958'</span>))
disp(sprintf(<span class="string">'median               0                  0'</span>))
disp(sprintf(<span class="string">'mean              0.0243        0.0227'</span>))
disp(sprintf(<span class="string">'st dev            0.0.0940        0.0981'</span>))
</pre><pre class="codeoutput">Parameter        Manual VAT        Semiauto VAT
volume             2973               1958
median               0                  0
mean              0.0243        0.0227
st dev            0.0.0940        0.0981
</pre><h2 id="17">Part V - Compare Post VAT vs. Pre VAT</h2><pre class="codeinput">close <span class="string">all</span>;
<span class="comment">%1-Manually Draw Visceral ROI</span>
<span class="comment">%Display image</span>
figure(<span class="string">'name'</span>,<span class="string">'FF Post Diet'</span>)
imagesc(FF_Post_masked);
title(<span class="string">'Manually Draw ROI of VAT'</span>);
colormap <span class="string">gray</span>
<span class="comment">%start timing</span>
tic
<span class="comment">%Code to draw an ROI</span>
freehandroi_aut_Post=imfreehand(gca);
autVATmask_Post_masked=createMask(freehandroi_aut_Post);
<span class="comment">%end timing</span>
autVATmask_Post_num_masked = double(autVATmask_Post_masked);
autVATroi_Post_masked=autVATmask_Post_num_masked.*FF_Post_masked;
<span class="comment">%Threshold the FF map to &gt; 50</span>
autVATthresh_Post_masked=zeros(img_size(1));
<span class="comment">%Generate a VAT ROI Fat Fraction (masked by viscera and by FF &gt; 50)</span>
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> FF_Post_masked(i,j)&gt;0.5
            autVATthresh_Post_masked(i,j)=autVATroi_Post_masked(i,j);
        <span class="keyword">else</span>
           autVATthresh_Post_masked(i,j)=0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%Make a Figure of VAT ROI FF image</span>
figure(<span class="string">'Name'</span>, <span class="string">'Automatic masked FF Post Diet'</span>)
imagesc(autVATthresh_Post_masked); colormap <span class="string">gray</span>
</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_26.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_27.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;
autVATFF_Pre(isnan(autVATthresh_Post_masked))=0;
Post_mean = mean(mean(autVATthresh_Post_masked));
Post_median = median(median(autVATthresh_Post_masked));
Post_std = std(std(autVATthresh_Post_masked));
figure()
Post_histogram = histogram(autVATthresh_Post_masked, 10);
Post_size = 0;
<span class="keyword">for</span> i = 1:img_size(1)
    <span class="keyword">for</span> j = 1:img_size(2)
        <span class="keyword">if</span> autVATthresh_Post_masked(i,j)&gt;0
            Post_size = Post_size+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
Pre_Post_diff = (autVATthresh_Pre_size - Post_size)/autVATthresh_Pre_size
figure()
subplot(2,1,1)
imagesc(autVATthresh_Post_masked); colormap <span class="string">gray</span>
title(<span class="string">'Automatic masked FF Pre Diet'</span>)
subplot(2,1,2)
imagesc(autVATthresh_Pre); colormap <span class="string">gray</span>
title(<span class="string">'Automatic masked FF Post Diet'</span>)
<span class="comment">% The mean for Day10 is lower than Pre Diet, as is the standard deviation</span>
<span class="comment">% The patient had a decrease in visceral fat from the diet.</span>
</pre><pre class="codeoutput">
Pre_Post_diff =

    0.3042

</pre><img vspace="5" hspace="5" src="liu_kristina_SegmentFat_28.png" alt=""> <img vspace="5" hspace="5" src="liu_kristina_SegmentFat_29.png" alt=""> <h2 id="19">Part  VI SAT Measurement</h2><p>Visceral Fat can be manually drawn out from the fat fraction map and created into a mask. Everything inside the mask will be a 0, leaving the subcutaneous fat.</p><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
% Kristina Liu
% BI 265
% Measurement of Fat Lab
%% Load images
clear all; close all; clc

current_dir = pwd;

%input = readidf_file_pc(current_file, current_dir);
%See help for options, esp for different operating systems
%image data will be stored in <input>.img

%Pre Diet 
current_file = 'data/suc047_4_S10';
VATslicePre = 30;  %15 if counting from first slice, 30 if counting from superior end

InPrer = read_idf_image_pc(strcat(current_file, '_In'), current_dir, 0);
OutPrer = read_idf_image_pc(strcat(current_file, '_Out'), current_dir, 0);
FPrer = read_idf_image_pc(strcat(current_file, '_F'), current_dir, 0);
WPrer = read_idf_image_pc(strcat(current_file, '_W'), current_dir, 0);
%record image size parameters 
img_size = size(InPrer.img(:,:,:));
%FYI
%img_rl = img_size(1);
%img_ap = img_size(2);
num_slices = img_size(3);
%other methods of collecting information: im.data, im.img

%Rotate and Flip the images to be in matlab-style format
for j=1:num_slices
    FPre(:,:,j) = flipud(imrotate(FPrer.img(:,:,j),90));
    WPre(:,:,j) = flipud(imrotate(WPrer.img(:,:,j),90));
    InPre(:,:,j) = flipud(imrotate(InPrer.img(:,:,j),90));
    OutPre(:,:,j) = flipud(imrotate(OutPrer.img(:,:,j),90));
end


%Display the image by slice - check read correctly
figure('Name', strcat('Original Image: ', current_file))
for j=1:img_size(3)
    imagesc(FPre(:,:,j))
    axis image
    title({'Fat: Slice',j});
    colormap gray
    pause(0.1)
end
%%

%Post Diet
current_dir = pwd;
current_file = 'data/suc047_2_S21';
VATslicePost = 27;   %18 if counting from first slice (inferior), 27 if counting
%from superior end

InPostr = read_idf_image_pc(strcat(current_file, '_In'), current_dir, 0);
OutPostr = read_idf_image_pc(strcat(current_file, '_Out'), current_dir, 0);
FPostr = read_idf_image_pc(strcat(current_file, '_F'), current_dir, 0);
WPostr = read_idf_image_pc(strcat(current_file, '_W'), current_dir, 0);

%record image size parameters 
img_size = size(InPostr.img(:,:,:));
%FYI
%img_rl = img_size(1);
%img_ap = img_size(2);
num_slices = img_size(3);
%other methods of collecting information: im.data, im.img

%Rotate and Flip the images to be in matlab-style format
for j=1:num_slices
    FPost(:,:,j) = flipud(imrotate(FPostr.img(:,:,j),90));
    WPost(:,:,j) = flipud(imrotate(WPostr.img(:,:,j),90));
    InPost(:,:,j) = flipud(imrotate(InPostr.img(:,:,j),90));
    OutPost(:,:,j) = flipud(imrotate(OutPostr.img(:,:,j),90));
end


%Display the image by slice - check read correctly
figure('Name', strcat('Original Image: ', current_file))
for j=1:img_size(3)
    imagesc(FPost(:,:,j))
    axis image
    title({'Fat: Slice',j});
    colormap gray
    pause(0.1)
end

%% Calculate Fat Fraction Map in [%]
close all;
FF_Pre=FPre(:,:,VATslicePre)./(FPre(:,:,VATslicePre)+WPre(:,:,VATslicePre));
figure('Name', 'Fat Fraction Pre Diet')
imagesc(FF_Pre); colormap gray

FF_Post=FPost(:,:,VATslicePost)./(FPost(:,:,VATslicePost)+ ...
    WPost(:,:,VATslicePost));
figure('Name', 'Fat Fraction Post Diet')
imagesc(FF_Post); colormap gray


%% Create Body/Good SNR Mask
close all;
MaskInPre=zeros(img_size(1));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if InPre(i,j,30)>125
            MaskInPre(i,j)=1;
        else 
            MaskInPre(i,j)=0;
        end
    end
end
figure('Name', 'Body Mask Pre Diet')
imagesc(MaskInPre); colormap gray

MaskInPost=zeros(img_size(1));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if InPost(i,j,30)>175
            MaskInPost(i,j)=1;
        else 
            MaskInPost(i,j)=0;
        end
    end
end
figure('Name', 'Body Mask Post Diet')
imagesc(MaskInPre); colormap gray
    
%Threshold an image set
%example:
%Inmask = In>100;
%% Apply a 2D filter to the mask (see help medfilt2)
close all;
MaskIn_Pre=medfilt2(MaskInPre);
%Evaluate filter -> Display, confirm threshold and filter choice
figure('Name', '2D Mask for Pre Diet')
imagesc(MaskIn_Pre); colormap gray
MaskIn_Post=medfilt2(MaskInPost);
%Evaluate filter -> Display, confirm threshold and filter choice
figure('Name', '2D Mask for Post Diet')
imagesc(MaskIn_Post); colormap gray


%% Apply this Body/SNR Mask to the FF map
close all;
FF_Pre_masked = MaskIn_Pre.*FF_Pre;
figure('Name', 'Pre Diet Masked FF')
imagesc(FF_Pre_masked); colormap gray

FF_Post_masked = MaskIn_Post.*FF_Post;
figure('Name', 'Post Diet Masked FF')
imagesc(FF_Post_masked); colormap gray

%Select Slice of Interest
%example:
%FFi=FF(:,:,VATslice);
%% 
close all;
subplot(1,3,1)
imagesc(FF_Pre); colormap gray
title('Pre Diet FF map')
subplot(1,3,2)
imagesc(MaskIn_Pre); colormap gray
title('Pre Diet Body Mask')
subplot(1,3,3)
imagesc(FF_Post_masked); colormap gray
title('Pre Diet Masked FF')

% The FF mask has the noise outside the body which the body mask removed in
% the masked FF. Step 3 and 4 created a median smoothed mask that allowed 
% values for values within the body and made everything outside 0.
% Changing the threshold will change the size and shape of the body mask. 
% You will not want to do these steps when thresholding does not
% differetiate noise from stucture well.

%% Manually Draw Visceral Fat ROI
close all;
%Display image
figure('name','FF Pre Diet')
imagesc(FF_Pre_masked);
title('Manually Draw ROI of VAT');
colormap gray
%start timing
tic
%Code to draw an ROI
freehandroi_man=imfreehand(gca);
manVATmask_Pre=createMask(freehandroi_man);
%end timing
manualVATtime_Pre = toc
manVATmask_Pre_num = double(manVATmask_Pre);
manVATFF_Pre=manVATmask_Pre_num.*FF_Pre_masked;
%% Characterize VAT ROI - histogram, size in pixels, mean, median, std
figure('Name', 'ROI FF Pre Diet')
imagesc(manVATFF_Pre); colormap gray

manVATFF_Pre(isnan(manVATFF_Pre))=0;
manVATFF_Pre_mean = mean(mean(manVATFF_Pre));
manVATFF_Pre_median = median(median(manVATFF_Pre));
manVATFF_Pre_std = std(std(manVATFF_Pre));
figure()
manVAT_Pre_histogram = histogram(manVATFF_Pre);
manVATFF_Pre_size = 0;
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if manVATFF_Pre(i,j)>0
            manVATFF_Pre_size = manVATFF_Pre_size+1;
        end
    end
end
%eg:
%manVATmean = mean(FFi(manVATmask)),
%% Part III  - Semiautomatically Generate VAT ROI - 
% 2-Automatically generate VAT mask and VAT-FF for:
%   1-Use Fat Fraction Map, 2 - Use masked Fat Fraction Map
close all;
%1-Manually Draw Visceral ROI
%Display image
figure('name','FF Pre Diet')
imagesc(FF_Pre);
title('Manually Draw ROI of VAT');
colormap gray
%start timing
tic
%Code to draw an ROI
freehandroi_aut=imfreehand(gca);
autVATmask_Pre=createMask(freehandroi_aut);
%end timing
autVATmask_Pre_num = double(autVATmask_Pre);
autVATroi_Pre=autVATmask_Pre_num.*FF_Pre;
figure('Name', 'Automatic ROI FF Pre Diet')
imagesc(autVATroi_Pre); colormap gray
%Threshold the FF map to > 50
autVATthresh_Pre=zeros(img_size(1));
for i = 1:img_size(1);
    for j = 1:img_size(2);
        if FF_Pre(i,j)>0.5
            autVATthresh_Pre(i,j)=autVATroi_Pre(i,j);
        else 
           autVATthresh_Pre(i,j)=0;
        end
    end
end
figure('Name', 'Automatic FF Pre Diet')
imagesc(autVATthresh_Pre); colormap gray
%% REPLACE_WITH_DASH_DASHRepeat for the masked Fat Fraction Map
close all;
%1-Manually Draw Visceral ROI
%Display image
figure('name','FF Pre Diet')
imagesc(FF_Pre_masked);
title('Manually Draw ROI of VAT');
colormap gray
%start timing
tic
%Code to draw an ROI
freehandroi_aut_masked=imfreehand(gca);
autVATmask_Pre_masked=createMask(freehandroi_aut_masked);
%end timing
autVATmask_Pre_num_masked = double(autVATmask_Pre_masked);
autVATroi_Pre_masked=autVATmask_Pre_num_masked.*FF_Pre_masked;
figure('Name', 'Automatic ROI FF Pre Diet')
imagesc(autVATroi_Pre_masked); colormap gray
%Threshold the FF map to > 50
autVATthresh_Pre_masked=zeros(img_size(1));
%Generate a VAT ROI Fat Fraction (masked by viscera and by FF > 50)
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if FF_Pre_masked(i,j)>0.5
            autVATthresh_Pre_masked(i,j)=autVATroi_Pre_masked(i,j);
        else 
           autVATthresh_Pre_masked(i,j)=0;
        end
    end
end

%Make a Figure of VAT ROI FF image
figure('Name', 'Automatic masked FF Pre Diet')
imagesc(autVATthresh_Pre_masked); colormap gray
%%
close all;
%Create a histogram of the VAT ROI Fat Fraction values
figure('Name', 'Visceral FF ROI')
autVAT_Pre__mask_histogram = histogram(autVATthresh_Pre_masked,10);
figure('Name', 'VAT FF ROI')
manVAT_Pre_histogram = histogram(manVATFF_Pre,10);
% Both histograms contain a majority of 0s. 
% The visceral FF ROI has distribution from
% 0.1 to 1. VAT ROI has a distribution between 0.5 and 1. 
% We have this shape for VAT because we
% thresholded all values below 0.5 while for the visceral ROI we manually
% drew it out.

%% Part IV - Determine Accuracy, Differences
close all;
autVATthresh_Pre(isnan(autVATthresh_Pre))=0;
autVATthresh_Pre_mean = mean(mean(autVATthresh_Pre));
autVATthresh_Pre_median = median(median(autVATthresh_Pre));
autVATthresh_Pre_std = std(std(autVATthresh_Pre));
autVATthresh_Pre_size = 0;
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre(i,j)>0
            autVATthresh_Pre_size = autVATthresh_Pre_size+1;
        end
    end
end
autVATthresh_Pre_masked(isnan(autVATthresh_Pre_masked))=0;
autVATthresh_Pre_masked_mean = mean(mean(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_median = median(median(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_std = std(std(autVATthresh_Pre_masked));
autVATthresh_Pre_masked_size = 0;
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre(i,j)>0
            autVATthresh_Pre_masked_size = autVATthresh_Pre_masked_size+1;
        end
    end
end

overlap_masked_FF_man_ROI = zeros(size(img_size));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre_masked(i,j) && manVATFF_Pre(i,j)>0
            overlap_masked_FF_man_ROI(i,j) = 1;
        end
    end
end

overlap_VAT_Visc = zeros(size(img_size));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre_masked(i,j) && manVATFF_Pre(i,j)>0
            overlap_VAT_Visc = overlap_VAT_Visc+1;
        end
    end
end
overlap_both_auto = zeros(size(img_size));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre_masked(i,j) && autVATthresh_Pre(i,j)>0
            overlap_both_auto(i,j) = 1;
        end
    end
end

overlap_mask = zeros(size(img_size));
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Pre_masked(i,j) && autVATthresh_Pre(i,j)>0
            overlap_mask = overlap_mask+1;
        end
    end
end
%Calculate Dice Coefficient & the %Difference in Size
%A - Compare VAT ROI on masked FF vs. manual VAT ROI
DC_VAT_Visc= 2.*overlap_both_auto/(manVATFF_Pre_size + ...
    autVATthresh_Pre_masked_size);
VAT_Visc_perc_diff = (manVATFF_Pre_size-autVATthresh_Pre_masked_size)/...
    manVATFF_Pre_size;

%B - Compare VAT ROI on masked FF to the VAT ROI on FF (not masked)

DC_VAT_Visc= 2.*overlap_mask/(autVATthresh_Pre_size + ...
    autVATthresh_Pre_masked_size);
mask_perc_diff = (autVATthresh_Pre_size + autVATthresh_Pre_masked_size)/...
    autVATthresh_Pre_size;
%%
%Display FF image, 2 masks, and overlap of the 2 masks
% A
close all;
figure('Name', 'A')
subplot(4,1,1)
imagesc(FF_Pre_masked); colormap gray
title('Masked FF Pre Diet')
subplot(4,1,2)
imagesc(autVATthresh_Pre_masked); colormap gray
title('Automatic masked ROI Pre Diet')
subplot(4,1,3)
imagesc(manVATFF_Pre); colormap gray
title('Manual VAT Roi Pre Diet')
subplot(4,1,4)
imagesc(overlap_masked_FF_man_ROI); colormap gray
title('Overlap Manual and Automatic')
% B
figure('Name', 'B')
subplot(4,1,1)
imagesc(FF_Pre_masked); colormap gray
title('Masked FF Pre Diet')
subplot(4,1,2)
imagesc(autVATthresh_Pre); colormap gray
title('Automatic masked FF Pre Diet')
subplot(4,1,3)
imagesc(autVATthresh_Pre_masked); colormap gray
title('Automatic FF Pre Diet')
subplot(4,1,4)
imagesc(overlap_both_auto); colormap gray
title('Overlap Manual and Automatic')

% The manual approach allows for fat fractions less than 0.5 percent 
%which the automatic ones does not.
% Automatically thresholding with an without noise makes no difference
% because they are NaN and replaced with zeros.
%%
%Calculate & Report stats on the VAT ROIs
%Summary of Results
disp(sprintf('Parameter        Manual VAT        Semiauto VAT'))
disp(sprintf('volume             2973               1958'))
disp(sprintf('median               0                  0'))
disp(sprintf('mean              0.0243        0.0227'))
disp(sprintf('st dev            0.0.0940        0.0981'))


%% Part V - Compare Post VAT vs. Pre VAT
close all;
%1-Manually Draw Visceral ROI
%Display image
figure('name','FF Post Diet')
imagesc(FF_Post_masked);
title('Manually Draw ROI of VAT');
colormap gray
%start timing
tic
%Code to draw an ROI
freehandroi_aut_Post=imfreehand(gca);
autVATmask_Post_masked=createMask(freehandroi_aut_Post);
%end timing
autVATmask_Post_num_masked = double(autVATmask_Post_masked);
autVATroi_Post_masked=autVATmask_Post_num_masked.*FF_Post_masked;
%Threshold the FF map to > 50
autVATthresh_Post_masked=zeros(img_size(1));
%Generate a VAT ROI Fat Fraction (masked by viscera and by FF > 50)
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if FF_Post_masked(i,j)>0.5
            autVATthresh_Post_masked(i,j)=autVATroi_Post_masked(i,j);
        else 
           autVATthresh_Post_masked(i,j)=0;
        end
    end
end

%Make a Figure of VAT ROI FF image
figure('Name', 'Automatic masked FF Post Diet')
imagesc(autVATthresh_Post_masked); colormap gray
%%
close all;
autVATFF_Pre(isnan(autVATthresh_Post_masked))=0;
Post_mean = mean(mean(autVATthresh_Post_masked));
Post_median = median(median(autVATthresh_Post_masked));
Post_std = std(std(autVATthresh_Post_masked));
figure()
Post_histogram = histogram(autVATthresh_Post_masked, 10);
Post_size = 0;
for i = 1:img_size(1)
    for j = 1:img_size(2)
        if autVATthresh_Post_masked(i,j)>0
            Post_size = Post_size+1;
        end
    end
end
Pre_Post_diff = (autVATthresh_Pre_size - Post_size)/autVATthresh_Pre_size
figure()
subplot(2,1,1)
imagesc(autVATthresh_Post_masked); colormap gray
title('Automatic masked FF Pre Diet')
subplot(2,1,2)
imagesc(autVATthresh_Pre); colormap gray
title('Automatic masked FF Post Diet')
% The mean for Day10 is lower than Pre Diet, as is the standard deviation
% The patient had a decrease in visceral fat from the diet.

%% Part  VI SAT Measurement
% Visceral Fat can be manually drawn out from the fat fraction map
% and created into a mask. Everything inside the mask will be a 0, 
% leaving the subcutaneous fat.

##### SOURCE END #####
--></body></html>